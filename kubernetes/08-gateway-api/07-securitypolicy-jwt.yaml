---
# Combined SecurityPolicy for Customer Route (JWT + External Authorization fetch)
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: customer-securitypolicy
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: customer-route
  jwt:
    providers:
    - name: keycloak-provider
      issuer: http://localhost:8180/realms/api-gateway-poc
      remoteJWKS:
        uri: http://keycloak.api-gateway-poc.svc.cluster.local:8180/realms/api-gateway-poc/protocol/openid-connect/certs
      claimToHeaders:
      - claim: email
        header: x-user-email
      - claim: preferred_username
        header: x-user-name
      - claim: email_verified
        header: x-email-verified
  extAuth:
    http:
      backendRefs:
      - name: authz-service
        port: 9000
      path: /authz/roles

---
# Combined SecurityPolicy for Auth-Me Route (JWT + External Authorization fetch)
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: authme-securitypolicy
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: auth-me-route
  jwt:
    providers:
    - name: keycloak-provider
      issuer: http://localhost:8180/realms/api-gateway-poc
      remoteJWKS:
        uri: http://keycloak.api-gateway-poc.svc.cluster.local:8180/realms/api-gateway-poc/protocol/openid-connect/certs
      claimToHeaders:
      - claim: email
        header: x-user-email
      - claim: preferred_username
        header: x-user-name
      - claim: email_verified
        header: x-email-verified
  extAuth:
    http:
      backendRefs:
      - name: authz-service
        port: 9000
      path: /authz/roles
