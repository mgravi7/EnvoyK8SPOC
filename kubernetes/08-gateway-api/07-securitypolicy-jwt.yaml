---
# SecurityPolicy for JWT-required Routes (Customer)
#
# Purpose:
# - Enforce JWT authentication for routes that MUST have a valid token
# - Use extAuth (authz-service) to perform role lookup and return x-user-roles
#
# Behavior:
# - `jwt.optional: false` (default) requires a valid JWT Authorization header.
#   Requests without a valid token are rejected by Envoy (401).
# - When a valid token is present Envoy extracts claims using claimToHeaders
#   and sends them to authz-service via headersToExtAuth.
# - authz-service looks up roles and returns x-user-roles (and can pass through
#   claim headers) which Envoy forwards to backend services via headersToBackend.
#
# Header Flow (Authenticated users):
# 1. Envoy validates token and extracts claims â†’ adds headers (x-user-email, x-user-name, x-email-verified)
# 2. headersToExtAuth forwards JWT-derived headers to authz-service
# 3. authz-service returns x-user-roles and passes through claim headers
# 4. Envoy forwards selected response headers to the backend via headersToBackend
#
# Note: Guests are NOT allowed on routes targeted by this policy.
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: jwt-required-routes-securitypolicy
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: customer-route
  jwt:
    optional: false
    providers:
    - name: keycloak-provider
      issuer: http://localhost:8180/realms/api-gateway-poc
      remoteJWKS:
        uri: http://keycloak.api-gateway-poc.svc.cluster.local:8180/realms/api-gateway-poc/protocol/openid-connect/certs
        cacheDuration: 300s
      claimToHeaders:
      - claim: email
        header: x-user-email
      - claim: preferred_username
        header: x-user-name
      - claim: email_verified
        header: x-email-verified
  extAuth:
    http:
      backendRefs:
      - name: authz-service
        port: 9000
      path: /authz/roles
      # Headers from authz-service response to forward to backend services
      headersToBackend:
      - x-user-email         # User email (authoritative from JWT)
      - x-user-name          # Username (from JWT preferred_username)
      - x-email-verified     # Email verification status (from JWT)
      - x-user-roles         # User roles (from authz-service database lookup)
    # JWT-derived headers to send to authz-service
    headersToExtAuth:
    - x-user-email
    - x-user-name
    - x-email-verified
