---
# SecurityPolicy for JWT Authentication
# Applies JWT validation to specific HTTPRoutes (not Gateway level)
# This allows us to exclude routes like /products that need anonymous access
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: jwt-authentication
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: customer-route
  jwt:
    providers:
    - name: keycloak-provider
      issuer: http://localhost:8180/realms/api-gateway-poc
      remoteJWKS:
        uri: http://keycloak.api-gateway-poc.svc.cluster.local:8180/realms/api-gateway-poc/protocol/openid-connect/certs
      claimToHeaders:
      - claim: email
        header: x-user-email
      - claim: preferred_username
        header: x-user-name
      - claim: realm_access.roles
        header: x-jwt-roles
---
# SecurityPolicy for JWT Authentication on auth-me route
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: jwt-authentication-auth-me
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: auth-me-route
  jwt:
    providers:
    - name: keycloak-provider
      issuer: http://localhost:8180/realms/api-gateway-poc
      remoteJWKS:
        uri: http://keycloak.api-gateway-poc.svc.cluster.local:8180/realms/api-gateway-poc/protocol/openid-connect/certs
      claimToHeaders:
      - claim: email
        header: x-user-email
      - claim: preferred_username
        header: x-user-name
      - claim: realm_access.roles
        header: x-jwt-roles
