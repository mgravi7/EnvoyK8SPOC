---
# SecurityPolicy for External Authorization (RBAC)
# Applies external authz check to specific HTTPRoutes (not Gateway level)
# This allows us to exclude routes that don't need authz
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: external-authorization
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: customer-route
  extAuth:
    http:
      backendRefs:
      - name: authz-service
        port: 9000
      path: /authz/roles
---
# SecurityPolicy for External Authorization on auth-me route
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: external-authorization-auth-me
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: auth-me-route
  extAuth:
    http:
      backendRefs:
      - name: authz-service
        port: 9000
      path: /authz/roles
