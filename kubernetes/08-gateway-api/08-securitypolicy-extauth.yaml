---
# SecurityPolicy for External Authorization (RBAC)
# Applies external authz check at the Gateway level for protected routes
# This replaces Phase 2's Envoy ext_authz filter configuration
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: external-authorization
  namespace: api-gateway-poc
  labels:
    app: api-gateway
    phase: phase3
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: api-gateway
    namespace: api-gateway-poc
  extAuth:
    http:
      # External authorization service endpoint
      service: authz-service.api-gateway-poc.svc.cluster.local
      port: 9000
      path: /authz/roles
      # Headers to send to the authorization service
      headersToExtAuth:
      - authorization
      - x-request-id
      - x-user-email
      - x-user-name
      # Headers to forward from the authorization service to upstream
      headersToUpstream:
      - x-user-email
      - x-user-roles
      # Fail closed - deny access if authz service is unavailable
      failOpen: false
